name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-22.04
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        export DEBIAN_FRONTEND=noninteractive
        
        # Install basic build tools
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          clang \
          lld \
          git \
          python3 \
          python3-pip \
          python3-distutils \
          curl \
          wget \
          pipx \
          gcc-12 \
          tree
        
        # Install other dependencies
        sudo apt-get install -y \
          libomp-dev \
          libssl-dev \
          zlib1g-dev \
          rapidjson-dev \
          libboost-dev \
          libre2-dev \
          librdmacm-dev
        
    - name: Cache Poplar SDK
      id: cache-poplar
      uses: actions/cache@v4
      with:
        path: ~/poplar
        key: poplar-sdk-ubuntu-20-04-3.4.0-69d9d03fd8
        
    - name: Install Poplar SDK
      if: steps.cache-poplar.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/poplar
        cd /tmp
        curl --location --request GET 'https://downloads.graphcore.ai/direct?package=poplar-poplar_sdk_ubuntu_20_04_3.4.0_69d9d03fd8-3.4.0&file=poplar_sdk-ubuntu_20_04-3.4.0-69d9d03fd8.tar.gz' --output 'poplar_sdk-ubuntu_20_04-3.4.0-69d9d03fd8.tar.gz'
        tar -xf poplar_sdk-ubuntu_20_04-3.4.0-69d9d03fd8.tar.gz -C ~/poplar
        rm poplar_sdk-ubuntu_20_04-3.4.0-69d9d03fd8.tar.gz
        
    - name: Install Conan
      run: |
        pipx install conan
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=RelWithDebInfo
        compiler=gcc
        compiler.cppstd=20
        compiler.libcxx=libstdc++11
        compiler.version=12
        os=Linux

        [conf]
        tools.cmake.cmaketoolchain:generator=Ninja
        EOF
      
    - name: Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2/p
        key: conan-packages
        restore-keys: |
          conan-packages
      
    - name: Install dependencies with Conan
      run: |
        conan create conan/fast_matrix_market
        conan create libgraphene/libs/twofloat

        conan install . --build=missing
        tree .
        
    - name: Configure with CMake
      run: |
        source ~/poplar/poplar_sdk-ubuntu_20_04-3.4.0+1507-69d9d03fd8/enable
        cd build
        cmake .. --preset conan-relwithdebinfo
        
    - name: Build
      run: |
        source ~/poplar/poplar_sdk-ubuntu_20_04-3.4.0+1507-69d9d03fd8/enable
        cmake --build build --parallel $(nproc)
        
    - name: Run tests
      run: |
        source ~/poplar/poplar_sdk-ubuntu_20_04-3.4.0+1507-69d9d03fd8/enable
        cd build
        ctest --output-on-failure --parallel $(nproc)